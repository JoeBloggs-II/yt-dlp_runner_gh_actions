name: Download YouTube Video with Login

on:
  workflow_dispatch:
  repository_dispatch:
    types: [yt-download-request]

jobs:
  download:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: Install Playwright and dependencies
      run: |
        npm install -D playwright
        npx playwright install --with-deps

    - name: Install yt-dlp
      run: |
        sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
        sudo chmod a+rx /usr/local/bin/yt-dlp

    - name: Install Python and conversion tools
      run: |
        sudo apt update
        sudo apt install -y python3-pip
        pip install playwright python-dotenv

    - name: Prepare URL list
      run: |
        if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
          echo "${{ github.event.client_payload.url }}" > URL.txt
        fi

    - name: Run Playwright login and export cookies
      env:
        LOGIN_EMAIL: ${{ secrets.LOGIN_EMAIL }}
        LOGIN_PASSWORD: ${{ secrets.LOGIN_PASSWORD }}
      run: |
        cat << 'EOF' > login.mjs
        import { chromium } from 'playwright';
        import fs from 'fs';

        const EMAIL = process.env.LOGIN_EMAIL;
        const PASSWORD = process.env.LOGIN_PASSWORD;

        const run = async () => {
          const browser = await chromium.launch({ headless: true });
          const context = await browser.newContext();
          const page = await context.newPage();

          await page.goto('https://www.youtube.com/');
          await page.getByRole('link', { name: 'Sign in' }).click();
          await page.getByRole('textbox', { name: 'Email or phone' }).fill(EMAIL);
          await page.getByRole('button', { name: /^Next$/ }).click();
          await page.waitForTimeout(2000);
          await page.screenshot({ path: 'before-username.png' });
          await page.getByRole('textbox', { name: 'Username' }).fill(EMAIL);
          await page.getByRole('button', { name: /^Next$/ }).click();
          await page.getByRole('textbox', { name: 'Password' }).fill(PASSWORD);
          await page.getByRole('button', { name: /^Verify$/ }).click();

          await page.waitForURL('https://www.youtube.com/*');

          const cookies = await context.cookies();
          const netscape = cookies.map(c => [
            c.domain.startsWith('.') ? c.domain : '.' + c.domain,
            'TRUE',
            c.path,
            c.secure ? 'TRUE' : 'FALSE',
            Math.floor(c.expires || 0),
            c.name,
            c.value
          ].join('\t')).join('\n');

          fs.writeFileSync('cookies.txt', '# Netscape HTTP Cookie File\n' + netscape);
          await browser.close();
        };

        run();
        EOF

        node login.mjs

    - name: Create output folder
      run: mkdir -p videos

    - name: Download YouTube video(s) with yt-dlp
      run: |
        while IFS= read -r url; do
          yt-dlp --cookies cookies.txt -f "bestvideo+bestaudio/best" --merge-output-format mp4 \
            "$url" -o "videos/%(title)s.%(ext)s"
        done < URL.txt

    - name: Upload downloaded video(s) as artifact
      uses: actions/upload-artifact@v4
      with:
        name: downloaded-video
        path: videos/
